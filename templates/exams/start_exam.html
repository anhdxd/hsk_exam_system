{% extends 'base.html' %}
{% load static %}

{% block title %}Bắt đầu thi - {{ exam.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/variables.css' %}">
<link rel="stylesheet" href="{% static 'css/exams/exam_common.css' %}">
<link rel="stylesheet" href="{% static 'css/exams/start_exam.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="start-exam-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-3">
                    <i class="fas fa-play-circle"></i> Bắt đầu thi
                </h1>
                <h2 class="mb-3">{{ exam.title }}</h2>
                <p class="lead mb-0">{{ exam.description|default:"Kỳ thi HSK" }}</p>
            </div>
            <div class="col-md-4 text-md-right">
                <div class="text-light">
                    <h4><i class="fas fa-layer-group"></i> {{ exam.hsk_level.name }}</h4>
                    <p class="mb-0">{{ exam.hsk_level.description }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- Exam Information -->
            <div class="exam-info-container">
                <div class="exam-detail-card">
                    <h5><i class="fas fa-info-circle"></i> Thông tin kỳ thi</h5>
                    
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fas fa-question-circle"></i> Số câu hỏi
                        </div>
                        <div class="info-value">
                            <strong>{{ exam.total_questions }} câu</strong>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fas fa-clock"></i> Thời gian thi
                        </div>
                        <div class="info-value">
                            <strong>{{ exam.duration_minutes }} phút</strong>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fas fa-percent"></i> Điểm qua
                        </div>
                        <div class="info-value">
                            <strong>{{ exam.passing_score }}%</strong>
                        </div>
                    </div>
                    
                    {% if exam.max_attempts %}
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fas fa-redo"></i> Số lần thi tối đa
                        </div>
                        <div class="info-value">
                            <strong>{{ exam.max_attempts }} lần</strong>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fas fa-random"></i> Trộn câu hỏi
                        </div>
                        <div class="info-value">
                            {% if exam.randomize_questions %}
                                <span class="text-success"><i class="fas fa-check"></i> Có</span>
                            {% else %}
                                <span class="text-muted"><i class="fas fa-times"></i> Không</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fas fa-eye"></i> Xem kết quả ngay
                        </div>
                        <div class="info-value">
                            {% if exam.show_results_immediately %}
                                <span class="text-success"><i class="fas fa-check"></i> Có</span>
                            {% else %}
                                <span class="text-muted"><i class="fas fa-times"></i> Không</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                {% if exam.instructions %}
                <div class="exam-detail-card">
                    <h5><i class="fas fa-clipboard-list"></i> Hướng dẫn thi</h5>
                    <div class="mt-3">
                        {{ exam.instructions|linebreaks }}
                    </div>
                </div>
                {% endif %}
                
                <!-- Requirements -->
                <div class="requirements-box">
                    <h6><i class="fas fa-exclamation-triangle"></i> Yêu cầu quan trọng</h6>
                    <ul class="requirements-list">
                        <li>
                            <i class="fas fa-wifi"></i>
                            Đảm bảo kết nối internet ổn định trong suốt quá trình thi
                        </li>
                        <li>
                            <i class="fas fa-desktop"></i>
                            Không đóng trình duyệt hoặc tải lại trang trong khi đang thi
                        </li>
                        <li>
                            <i class="fas fa-clock"></i>
                            Thời gian thi sẽ được tính ngay khi bạn bắt đầu
                        </li>
                        <li>
                            <i class="fas fa-save"></i>
                            Câu trả lời sẽ được tự động lưu khi bạn chuyển câu
                        </li>
                        {% if exam.allow_navigation %}
                        <li>
                            <i class="fas fa-arrow-left"></i>
                            Bạn có thể quay lại câu trước để sửa đáp án
                        </li>
                        {% else %}
                        <li>
                            <i class="fas fa-lock"></i>
                            Không thể quay lại câu trước sau khi đã chuyển câu
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- Time Warning -->
                {% if exam.duration_minutes >= 60 %}
                <div class="timer-warning">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Lưu ý:</strong> Kỳ thi này kéo dài {{ exam.duration_minutes }} phút. 
                    Hãy chuẩn bị đầy đủ thời gian và không để bị gián đoạn.
                </div>
                {% endif %}
                
                <!-- Confirmation Form -->
                <form method="post" class="mt-4">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="checkbox-container">
                        <div class="form-check">                            {{ form.confirm }}
                            <label class="form-check-label" for="{{ form.confirm.id_for_label }}">
                                <i class="success-icon fas fa-check-circle"></i>
                                Tôi đã đọc và hiểu các yêu cầu. Tôi sẵn sàng bắt đầu thi.
                            </label>                        </div>
                        {% if form.confirm.errors %}
                            <div class="text-danger mt-2">
                                {{ form.confirm.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-start-exam mr-3" id="startExamBtn" disabled>
                            <i class="fas fa-play"></i> Bắt đầu thi ngay
                        </button>
                        <a href="{% url 'exams:detail' exam.pk %}" class="btn btn-cancel">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Enable/disable start button based on confirmation checkbox
    $('#{{ form.confirm.id_for_label }}').on('change', function() {
        if ($(this).is(':checked')) {
            $('#startExamBtn').prop('disabled', false)
                .removeClass('btn-secondary')
                .addClass('btn-start-exam');
        } else {
            $('#startExamBtn').prop('disabled', true)
                .removeClass('btn-start-exam')
                .addClass('btn-secondary');
        }
    });
    
    // Confirmation before starting exam
    $('form').on('submit', function(e) {
        if (!$('#{{ form.confirm.id_for_label }}').is(':checked')) {
            e.preventDefault();
            alert('Vui lòng xác nhận bạn đã sẵn sàng bắt đầu thi.');
            return false;
        }
        
        var confirmed = confirm(
            'Bạn có chắc chắn muốn bắt đầu thi?\n\n' +
            'Thời gian sẽ được tính ngay sau khi bắt đầu và không thể dừng lại.\n' +
            'Hãy đảm bảo bạn có đủ thời gian và không bị gián đoạn.'
        );
        
        if (confirmed) {
            // Disable button to prevent double submission
            $('#startExamBtn').prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin"></i> Đang khởi tạo...');
        }
        
        return confirmed;
    });
    
    // Auto-focus on checkbox when page loads
    setTimeout(function() {
        $('#{{ form.confirm.id_for_label }}').focus();
    }, 500);
    
    // Prevent back button during exam preparation
    window.history.pushState(null, null, window.location.href);
    window.onpopstate = function () {
        if (confirm('Bạn có chắc chắn muốn rời khỏi trang này?')) {
            window.history.back();
        } else {
            window.history.pushState(null, null, window.location.href);
        }
    };
});
</script>
{% endblock %}
